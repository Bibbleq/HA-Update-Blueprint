input_text: # You can create the input_text using the UI (Settings > Devices & Services > Helpers)
  vasttrafik_api_key:
    name: Vasttrafik - API Key
    initial: !secret vasttrafik_api_key
    mode: password
  vasttrafik_api_secret:
    name: Vasttrafik - API Secret
    initial: !secret vasttrafik_api_secret
    mode: password
  vasttrafik_stop_area_id_01:
    name: Vasttrafik - Stop Area Id 01
    initial: !secret vasttrafik_station_1_id
    mode: password

rest:
  - resource: https://ext-api.vasttrafik.se/token
    method: POST
    payload: 'grant_type=client_credentials'
    headers:
      Content-Type: application/x-www-form-urlencoded
      Authorization: >-
        Basic {{ (states('input_text.vasttrafik_api_key') + ':' + states('input_text.vasttrafik_api_secret')) | base64_encode }}
    scan_interval: 60
    sensor:
      - name: Vasttrafik - Access token
        unique_id: f537b324-9b30-4a4e-9c03-d15920e33f11
        device_class: timestamp
        availability: '{{ value_json is defined and value_json.expires_in is defined }}'
        value_template: "{{ now() + timedelta(seconds= value_json.expires_in | int(0) ) }}"
        json_attributes:
          - access_token
          - scope
          - token_type
          - expires_in

  ##### Vasttrafik API v4 parameters:
  # stopAreaGid                       (string)    The 16-digit Västtrafik gid of the stop area. (MANDATORY)
  # startDateTime                     (string)    The start of the time interval for which to get upcoming departures. Must be specified in RFC 3339 format or be null which means that the current time on the server is used.
  # platforms                         (string)    Filter results by platform. Multiple platforms are separated by comma. Case sensitive.
  # timeSpanInMinutes                 (int32)     The number of minutes from the start time for which to get upcoming departures. Allowed values are between 0 and 1440.
  # maxDeparturesPerLineAndDirection  (int32)     The maximum number of departures for a single line in a specific direction.
  # limit                             (int32)     The number of results to return.
  # offset                            (int32)     The zero-based start offset of the pagination.
  # includeOccupancy                  (boolean)   Includes occupancy in departure.
  # directionGid                      (string)    Filter result by last stop on journey. Must be a 16-digit Västtrafik stop area
  - resource_template: '{{ "https://ext-api.vasttrafik.se/pr/v4/stop-areas/" ~ states("input_text.vasttrafik_stop_area_id_01") ~ "/departures" }}'
    method: GET
    params:
      # startDateTime: '{{ now().isoformat() }}'
      maxDeparturesPerLineAndDirection: 5
      limit: 30
      includeOccupancy: false
    headers:
      Content-Type: application/x-www-form-urlencoded
      Authorization: >-
        {{ state_attr('sensor.vasttrafik_access_token', 'token_type') }} {{ state_attr('sensor.vasttrafik_access_token', 'access_token') }}
    scan_interval: 60
    sensor:
      - name: Vasttrafik - Departure table
        unique_id: dd13c9ef-b007-42be-8fb8-bdbcf7f06ab7
        device_class: timestamp
        availability: '{{ has_value("input_text.vasttrafik_stop_area_id_01") and value_json is defined }}'
        value_template: '{{ now() }}'
        #json_attributes_path: "$.Results"
        json_attributes:
          - results

template:
  sensor:
    - name: Vasttrafik - Departure table - City centre
      unique_id: 8a3c040f-54ee-48be-82b2-2935dd14d44f
      device_class: timestamp
      availability: '{{ has_value("sensor.vasttrafik_departure_table") }}'
      state: '{{ states("sensor.vasttrafik_departure_table") }}'
      attributes:
        Departure: >
          {{
            state_attr("sensor.vasttrafik_departure_table", "results")
            | selectattr("stopPoint", "defined")
            | selectattr("stopPoint.platform", "defined")
            | selectattr("stopPoint.platform", "in", ["A","a", "C", "c"])
            | list
          }}

    - name: Vasttrafik - Departure table - Suburb
      unique_id: 1c66df5e-05dc-4514-90a7-836093523c18
      device_class: timestamp
      availability: '{{ has_value("sensor.vasttrafik_departure_table") }}'
      state: '{{ states("sensor.vasttrafik_departure_table") }}'
      attributes:
        Departure: >
          {{
            state_attr("sensor.vasttrafik_departure_table", "results")
            | selectattr("stopPoint", "defined")
            | selectattr("stopPoint.platform", "defined")
            | selectattr("stopPoint.platform", "in", ["B","b"])
            | list
          }}

#sensor:
  # https://www.home-assistant.io/integrations/vasttrafik/
  #- platform: vasttrafik
  #  key: !secret vasttrafik_api_key
  #  secret: !secret vasttrafik_api_secret
  #  departures:
  #    - from: !secret vasttrafik_station_1_id
  #      name: !secret vasttrafik_station_1_sensor_name
